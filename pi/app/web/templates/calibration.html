{% extends "base.html" %}
{% block content %}
<h1>Calibration</h1>

<div class="grid2">
  <div class="card">
    <div class="card-title">Start</div>
    <div class="muted">
      Start nutzt <code>POST /api/v1/calibration/start</code> mit <code>tag_mac</code>.
      Optional: <code>duration_ms</code>.
    </div>

    <div class="formgrid" style="margin-top:10px;">
      <label>Tag <span class="req">*</span>
        <select id="cal_tag_mac" required></select>
      </label>
      <label>duration_ms
        <input id="cal_duration" type="number" value="6000" min="1000" />
      </label>
    </div>

    <div class="row">
      <button class="btn primary" onclick="ltCalibrationStart()">Start</button>
      <button class="btn" onclick="ltCalibrationAbort()">Abort</button>
      <button class="btn" onclick="ltCalibrationPrecheck()">Refresh State</button>
      <button class="btn" id="cal_commit_btn" onclick="ltCalibrationCommit()" style="display:none">Commit</button>
      <button class="btn danger" id="cal_discard_btn" onclick="ltCalibrationDiscard()" style="display:none">Discard</button>
    </div>

    <div class="kv" style="margin-top:12px;">
      <div class="k">State</div><div class="v" id="cal_state">…</div>
      <div class="k">MQTT</div><div class="v" id="cal_mqtt">…</div>
      <div class="k">Anchors Online</div><div class="v" id="cal_anchors">…</div>
    </div>

    <pre class="pre" id="cal_out"></pre>
  </div>

  <div class="card">
    <div class="card-title">Runs</div>
    <div class="muted">GET <code>/api/v1/calibration/runs?tag_mac=…</code> und <code>/runs/{run_id}</code>.</div>

    <div class="row" style="margin-top:10px;">
      <button class="btn" onclick="ltCalibrationLoadRuns()">Load Runs</button>
      <button class="btn" onclick="ltCalibrationLoadSelectedRun()">Load Selected Run</button>
    </div>

    <div class="formgrid" style="margin-top:10px;">
      <label>tag_mac filter
        <input id="cal_runs_tag_mac" placeholder="leer = alle" />
      </label>
      <label>run_id
        <input id="cal_run_id" placeholder="z.B. 123" />
      </label>
    </div>

    <pre class="pre" id="cal_runs_out"></pre>
  </div>
</div>

<div class="card" style="margin-top:14px;">
  <div class="card-title">Venue Calibration (5 points)</div>
  <div class="muted">
    Nutzt Tag und duration_ms aus dem Start-Block. Punkte: (0,0,z), (+/-d,0,z), (0,+/-d,z).
  </div>

  <div class="formgrid" style="margin-top:10px;">
    <label>grid_cm
      <select id="cal_point_grid">
        <option value="100">100</option>
        <option value="200">200</option>
      </select>
    </label>
    <label>z_cm
      <input id="cal_point_z" type="number" value="150" min="0" />
    </label>
  </div>

  <div class="row" style="margin-top:10px;">
    <button class="btn primary" onclick="ltCalibrationMeasurePoint('center')">Center</button>
    <button class="btn" onclick="ltCalibrationMeasurePoint('xp')">+X</button>
    <button class="btn" onclick="ltCalibrationMeasurePoint('xn')">-X</button>
    <button class="btn" onclick="ltCalibrationMeasurePoint('yp')">+Y</button>
    <button class="btn" onclick="ltCalibrationMeasurePoint('yn')">-Y</button>
  </div>

  <div class="row" style="margin-top:10px;">
    <button class="btn" onclick="ltCalPointReset()">Reset Session</button>
    <div class="muted">session_id: <span id="cal_point_session">none</span></div>
  </div>

  <pre class="pre" id="cal_point_out"></pre>
</div>

<div class="card" style="margin-top:14px;">
  <div class="card-title">Venue Calibration Apply</div>
  <div class="muted">
    Nutzt die letzten 5 Punkte des Tag-MAC. Berechnet Range-Korrektur pro Anchor und Anchor-Offsets.
  </div>
  <div class="row" style="margin-top:10px;">
    <label style="display:flex; align-items:center; gap:8px;">
      <input id="cal_solve_apply" type="checkbox" checked />
      Apply Settings (MQTT + Offsets speichern)
    </label>
    <button class="btn primary" onclick="ltCalibrationSolve()">Solve & Apply</button>
  </div>
  <pre class="pre" id="cal_solve_out"></pre>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  ltRefreshFooterState();
  ltCalibrationLoadTags();
  ltCalibrationPrecheck();
  ltCalPointRender();
  // start polling calibration status
  setInterval(() => ltUpdateCalibrationStatus(), 1000);
});
</script>
{% endblock %}
