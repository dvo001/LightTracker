{% extends "base.html" %}
{% block content %}
<h1>Calibration</h1>

<div class="grid2">
  <div class="card">
    <div class="card-title">Start</div>
    <div class="muted">
      Start nutzt <code>POST /api/v1/calibration/start</code> mit <code>tag_mac</code>.
      Optional: <code>duration_ms</code>.
    </div>

    <div class="formgrid" style="margin-top:10px;">
      <label>tag_mac <span class="req">*</span>
        <input id="cal_tag_mac" placeholder="AA:BB:CC:DD:EE:FF" required />
      </label>
      <label>duration_ms
        <input id="cal_duration" type="number" value="6000" min="1000" />
      </label>
    </div>

    <div class="row">
      <button class="btn primary" onclick="ltCalibrationStart()">Start</button>
      <button class="btn" onclick="ltCalibrationAbort()">Abort</button>
      <button class="btn" onclick="ltCalibrationPrecheck()">Refresh State</button>
      <button class="btn" id="cal_commit_btn" onclick="ltCalibrationCommit()" style="display:none">Commit</button>
      <button class="btn danger" id="cal_discard_btn" onclick="ltCalibrationDiscard()" style="display:none">Discard</button>
    </div>

    <div class="kv" style="margin-top:12px;">
      <div class="k">State</div><div class="v" id="cal_state">…</div>
      <div class="k">MQTT</div><div class="v" id="cal_mqtt">…</div>
      <div class="k">Anchors Online</div><div class="v" id="cal_anchors">…</div>
    </div>

    <pre class="pre" id="cal_out"></pre>
  </div>

  <div class="card">
    <div class="card-title">Runs</div>
    <div class="muted">GET <code>/api/v1/calibration/runs?tag_mac=…</code> und <code>/runs/{run_id}</code>.</div>

    <div class="row" style="margin-top:10px;">
      <button class="btn" onclick="ltCalibrationLoadRuns()">Load Runs</button>
      <button class="btn" onclick="ltCalibrationLoadSelectedRun()">Load Selected Run</button>
    </div>

    <div class="formgrid" style="margin-top:10px;">
      <label>tag_mac filter
        <input id="cal_runs_tag_mac" placeholder="leer = alle" />
      </label>
      <label>run_id
        <input id="cal_run_id" placeholder="z.B. 123" />
      </label>
    </div>

    <pre class="pre" id="cal_runs_out"></pre>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  ltRefreshFooterState();
  ltCalibrationPrecheck();
  // start polling calibration status
  setInterval(() => ltUpdateCalibrationStatus(), 1000);
});
</script>
{% endblock %}
